<xml xmlns="https://developers.google.com/blockly/xml"><variables></variables><block type="pxt-on-start" id="zHcYbX5;To%K@+_MU/05" x="0" y="0"><statement name="HANDLER"><block type="typescript_statement" id="riKSa(+Y+buIls2at%SO"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="namespace ZETag_R2b {" line1="    const txBuffer = pins.createBuffer(1);" line2="" line3="    /**" line4="     * Binary data transmission over UART" line5="     * @param TX_data: 8bit data" line6="    */" line7="    function UART_BIN_TX(txData: number): void {" line8="        txBuffer.setUint8(0, txData);" line9="        serial.writeBuffer(txBuffer)" line10="    }" line11="" line12="    /**" line13="     * Binary data reception over UART" line14="     * @param value: none" line15="     * @return value: 16bit data If return value is 256, reception time out." line16="    */" line17="    function UART_BIN_RX(): number {" line18="        const rxBuffer = serial.readBuffer(1)   // Bloking function (wait till receipt)" line19="        if (rxBuffer.length &gt; 0) {              // When receive data, alway length &gt; 0" line20="            return rxBuffer[0]" line21="        }" line22="        return 0;                               // Never come to this line." line23="     }" line24="" line25="    function receive_query(): number[]  {" line26="        let response = [0, 0, 0, 0, 0, 0, 0, 0, 0]" line27="        let timeoutCounter = 0" line28="" line29="        while (true) {" line30="            const data = UART_BIN_RX();" line31="            if (data == 0xff) break;" line32="            timeoutCounter++;" line33="            if (timeoutCounter &gt; 15) return response; // Timeout" line34="        }" line35="" line36="        if (UART_BIN_RX() == 0) {   // FF 00 を待つ" line37="            response[0] = 0xff;" line38="            response[1] = 0x0;" line39="            let length = UART_BIN_RX();" line40="            if (length &gt; 6) length = 6;" line41="            response[2] = length;" line42="            let sum = 0xff+ 0x00 + length" line43="            for (let i = 0; i &lt; length - 1; i++) {" line44="                const d = UART_BIN_RX() &amp; 0xff;" line45="                response[3 + i] = d;" line46="                sum += d;" line47="            }" line48="            const crc = UART_BIN_RX() &amp; 0xFF;" line49="            response[length+2] = crc;   // Store CRC data to response" line50="            response = response.slice(0, length + 3); //omit redandant data" line51="            if ((sum &amp; 0xff) != crc) {" line52="                response = [3]" line53="            }" line54="        }" line55="        else    response = [1];" line56="        if (response[3] == 0xff) {" line57="            response = [2]" line58="        }" line59="        return response" line60="    }" line61="" line62="    /**" line63="     * Send ZETag command execution" line64="     * @param txArray : number[]" line65="     * @param querySize: number" line66="     * @return queryData[]" line67="        queryData[0]:" line68="                0xff&#9;Query data is ready," line69="                   1    Time out error," line70="                   2&#9;Size error (Query size &lt;&gt; Receipt size)," line71="                   3    ZeTag error," line72="                   4    Checksum error," line73="                   5    Query data error" line74="       */" line75="    //% blockId=Send_ZETag_command block=&quot;Send ZETag command %txArray&quot;" line76="    //% subcategory=&quot;その他&quot;" line77="    //% weight=80 blockGap=8" line78="    export function Send_ZETag_command(txArray: number[]): number[] {" line79="        const txArraySize = txArray.length" line80="        for (let l = 0; l &lt; txArraySize; l++) {" line81="            UART_BIN_TX(txArray[l])" line82="        }" line83="        let queryData = receive_query()" line84="        if ((queryData[3] == 0xf1) &amp;&amp; (txArray[3] == 0xf0)) {" line85="            return queryData" line86="        } else if (queryData[3] != txArray[3]) {" line87="            queryData[0] = 4" line88="        }" line89="        if (queryData[3] != txArray[3]) {" line90="            if ((queryData[3] != 0xf1) || (txArray[3] != 0xf0)){" line91="                queryData[0] = 4" line92="            }" line93="        }" line94="        return queryData" line95="    }" line96="" line97="    /**" line98="     * send zetag application data" line99="     */" line100="    //% blockId=Transmit_ZETag_data block=&quot;Transmit ZETag data %dataArray&quot;" line101="    //% weight=80 blockGap=8" line102="    export function Transmit_ZETag_data(txArray: number[]): void {" line103="        // 0xff+2+0x80=0x181 -&gt; 0x81" line104="        // Query FF 00 02 80 81" line105="        let num = txArray.length" line106="        if (num &lt; 1)    return;" line107="        if (num &gt; 30)   num = 30;" line108="        // 0xff+2+0x80=0x181 -&gt; 0x81  FF 00 02 80 xx xx xx" line109="        let checkSum = 0x81 + num" line110="        for (let m = 0; m &lt; num; m++){" line111="            checkSum += txArray[m]" line112="        }" line113="        checkSum %= 256;" line114="        const header = [0xff, 0x00, num + 2, 0x80];" line115="        const response2 = Send_ZETag_command(header.concat(txArray).concat([checkSum]));" line116="    }" line117="" line118="    /**" line119="     * set tx power" line120="     */" line121="    //% blockId=Set TX_Power block=&quot;Set TX Power %txPower (dB)&quot;" line122="    //% weight=80 blockGap=8" line123="    //% txPower.min=1 txPower.max=10 txPower.defl=10" line124="    export function Set_TX_Power(txPower: number): void {" line125="        if (txPower == 0) txPower = 1;" line126="        else if (txPower &gt;= 10) txPower = 10;" line127="" line128="        let txPowerData = txPower * 2" line129="        // FF 00 03 41 10 53; 出力8dB設定" line130="        // FF+00+03+41=0x143 -&gt; 0x43" line131="        // Query FF 00 02 41 42" line132="        const response4 = Send_ZETag_command([0xff, 0x00, 0x03, 0x41, txPowerData, (0x43 + txPowerData) % 256])" line133="    }" line134="" line135="    /**" line136="     * set channel spacing" line137="     */" line138="    //% blockId=set_channel_spacing block=&quot;Set channel spacing %chSpace (KHz)&quot;" line139="    //% weight=80 blockGap=8" line140="    //% chSpace.min=100 chSpace.max=200 chSpace.defl=100" line141="    export function Set_channel_spacing(chSpace: number): void {" line142="        // FF 00 03 F0 64 56; 100KHz設定" line143="        // FF+00+03+F0=1F2 -&gt; 0xf2" line144="        // Query FF 00 02 F1 F2" line145="        if (chSpace &lt;= 100) {" line146="            chSpace = 100" line147="        } else if (chSpace &gt;= 200) {" line148="            chSpace = 200" line149="        }" line150="        const response3 = Send_ZETag_command([0xff, 0x00, 0x03, 0xf0, chSpace, (0xf2 + chSpace) % 256]);" line151="    }" line152="" line153="    /**" line154="     * set transmission frequency" line155="     */" line156="    //% blockId=Set_Frequency block=&quot;Set Frequency %frequency (Hz) %chNum (ch) %chStep&quot;" line157="    //% weight=80 blockGap=8" line158="    //% Frequency.min=470000000 Frequency.max=928000000 Frequency.defl=922080000" line159="    //% chNum.min=1 chNum.max=6 chNum.defl=2" line160="    //% chStep.min=1 chStep.max=2 chStep.defl=2" line161="    export function Set_Frequency(frequency: number, chNum: number, chStep: number): void {" line162="        // Query FF 00 02 40 41" line163="        if (chNum &lt;= 1) chNum = -1;" line164="        else if (chNum &gt;= 6) chNum = 6;" line165="" line166="        if (chStep == 0) chStep = 1;" line167="        else if (chStep &gt;= 2) chStep = 2;" line168="" line169="        if (frequency &lt; 470000000) frequency = 470000000;" line170="        else if (frequency &gt; 928000000) frequency = 928000000;" line171="        else if ((frequency &gt; 510000000) &amp;&amp; (frequency &lt; 920600000)) frequency = 510000000;" line172="" line173="        let txArray = [" line174="            0xff, 0x00, 0x08 + chNum, 0x40, 0x01," line175="            (frequency &gt;&gt; 24) &amp; 0xff," line176="            (frequency &gt;&gt; 16) &amp; 0xff," line177="            (frequency &gt;&gt; 8) &amp; 0xff," line178="            frequency &amp; 0xff," line179="            chNum, 0, 0, 0, 0, 0, 0, 0" line180="        ]" line181="        if (chNum &gt;= 2) {" line182="            for (let n = 0; n &lt; chNum; n++) {" line183="                txArray[10 + n] = n * chStep" line184="            }" line185="        } else {" line186="            txArray[4] = 0" line187="        }" line188="        let checkSum2 = 0" line189="        for (let o = 0; o &lt; chNum + 10; o++) {" line190="            checkSum2 += txArray[o]" line191="        }" line192="        checkSum2 %= 256" line193="        txArray[10 + chNum] = checkSum2" line194="" line195="        txArray = txArray.slice(0, 11 + chNum); //omit redandant data" line196="        " line197="        const response5 = Send_ZETag_command(txArray)" line198="    }" line199="}" numlines="200"></mutation></block></statement></block></xml>