<xml xmlns="https://developers.google.com/blockly/xml"><variables></variables><block type="pxt-on-start" id="exZHM)z]G)ErQn-2N`eE" x="0" y="0"><statement name="HANDLER"><block type="typescript_statement" id="Tc.kg)vdxBIpy#3f~@SL"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="namespace ZETag_R2a {" line1="    const txBuffer = pins.createBuffer(1);" line2="" line3="    /**" line4="     * Binary data transmission over UART" line5="     * @param TX_data: 8bit data" line6="    */" line7="    function UART_BIN_TX(txData: number): void {" line8="        txBuffer.setUint8(0, txData);" line9="        serial.writeBuffer(txBuffer)" line10="    }" line11="" line12="    /**" line13="     * Binary data reception over UART" line14="     * @param value: none" line15="     * @return value: 16bit data If return value is 256, reception time out." line16="    */" line17="    function UART_BIN_RX(): number {" line18="        const rxBuffer = serial.readBuffer(1)   // Bloking function (wait till receipt)" line19="        if (rxBuffer.length &gt; 0) {              // When receive data, alway length &gt; 0" line20="            return rxBuffer[0]" line21="        }" line22="        return 0;                               // Never come to this line." line23="     }" line24="" line25="    function receive_query(): number[]  {" line26="        const response = [0, 0, 0, 0, 0, 0, 0, 0, 0]" line27="        let timeoutCounter = 0" line28="" line29="        while (true) {" line30="            const data = UART_BIN_RX();" line31="            if (data == 0xff) break;" line32="            timeoutCounter++;" line33="            if (timeoutCounter &gt; 15) return response; // Timeout" line34="        }" line35="" line36="        if (UART_BIN_RX() == 0) {   // FF 00 を待つ" line37="            response[0] = 0xff;" line38="            response[1] = 0x0;" line39="            let length = UART_BIN_RX();" line40="            if (length &gt; 6) length = 6;" line41="            response[2] = length;" line42="            let sum = 0xff+ 0x00 + length" line43="            for (let i = 0; i &lt; length - 1; i++) {" line44="                const d = UART_BIN_RX() &amp; 0xff;" line45="                response[3 + i] = d;" line46="                sum += d;" line47="            }" line48="            const crc = UART_BIN_RX() &amp; 0xFF;" line49="            response[length+2] = crc;   // Store CRC data to response" line50="            if ((sum &amp; 0xff) != crc) {" line51="                response[0] = 3" line52="            }" line53="        }" line54="        else    response[0] = 1;" line55="        if (response[3] == 0xff) {" line56="            response[0] = 2" line57="        }" line58="        return response" line59="    }" line60="" line61="    /**" line62="     * Send ZETag command execution" line63="     * @param txArray : number[]" line64="     * @param querySize: number" line65="     * @return queryData[]" line66="        queryData[0]:" line67="                0xff&#9;Query data is ready," line68="                   1    Time out error," line69="                   2&#9;Size error (Query size &lt;&gt; Receipt size)," line70="                   3    ZeTag error," line71="                   4    Checksum error," line72="                   5    Query data error" line73="       */" line74="    //% blockId=Send_ZETag_command block=&quot;Send ZETag command %txArray&quot;" line75="    //% weight=80 blockGap=8" line76="    export function Send_ZETag_command(txArray: number[]): number[] {" line77="        const txArraySize = txArray.length" line78="        for (let l = 0; l &lt; txArraySize; l++) {" line79="            UART_BIN_TX(txArray[l])" line80="        }" line81="        let queryData = receive_query()" line82="        if ((queryData[3] == 0xf1) &amp;&amp; (txArray[3] == 0xf0)) {" line83="            return queryData" line84="        } else if (queryData[3] != txArray[3]) {" line85="            queryData[0] = 4" line86="        }" line87="        if (queryData[3] != txArray[3]) {" line88="            if ((queryData[3] != 0xf1) || (txArray[3] != 0xf0)){" line89="                queryData[0] = 4" line90="            }" line91="        }" line92="        return queryData" line93="    }" line94="" line95="    /**" line96="     * send zetag application data" line97="     */" line98="    //% blockId=Transmit_ZETag_data block=&quot;Transmit ZETag data %dataArray&quot;" line99="    //% weight=80 blockGap=8" line100="    export function Transmit_ZETag_data(txArray: number[]): void {" line101="        // 0xff+2+0x80=0x181 -&gt; 0x81" line102="        // Query FF 00 02 80 81" line103="        let num = txArray.length" line104="        if (num &lt; 1)    return;" line105="        if (num &gt; 30)   num = 30;" line106="        // 0xff+2+0x80=0x181 -&gt; 0x81  FF 00 02 80 xx xx xx" line107="        let checkSum = 0x81 + num" line108="        for (let m = 0; m &lt; num; m++){" line109="            checkSum += txArray[m]" line110="        }" line111="        checkSum %= 256;" line112="        const header = [0xff, 0x00, num + 2, 0x80];" line113="        const response2 = Send_ZETag_command(header.concat(txArray).concat([checkSum]));" line114="    }" line115="" line116="    /**" line117="     * set channel spacing" line118="     */" line119="    //% blockId=set_channel_spacing block=&quot;Set channel spacing %chSpace (KHz)&quot;" line120="    //% weight=80 blockGap=8" line121="    //% chSpace.min=100 chSpace.max=200 chSpace.defl=100" line122="    export function Set_channel_spacing(chSpace: number): void {" line123="        // FF 00 03 F0 64 56; 100KHz設定" line124="        // FF+00+03+F0=1F2 -&gt; 0xf2" line125="        // Query FF 00 02 F1 F2" line126="        if (chSpace &lt;= 100) {" line127="            chSpace = 100" line128="        } else if (chSpace &gt;= 200) {" line129="            chSpace = 200" line130="        }" line131="        const response3 = Send_ZETag_command([0xff, 0x00, 0x03, 0xf0, chSpace, (0xf2 + chSpace) % 256]);" line132="    }" line133="" line134="    /**" line135="     * set tx power" line136="     */" line137="    //% blockId=Set TX_Power block=&quot;Set TX Power %txPower (dB)&quot;" line138="    //% weight=80 blockGap=8" line139="    //% txPower.min=1 txPower.max=10 txPower.defl=10" line140="    export function Set_TX_Power(txPower: number): void {" line141="        if (txPower == 0) txPower = 1;" line142="        else if (txPower &gt;= 10) txPower = 10;" line143="" line144="        let txPowerData = txPower * 2" line145="        // FF 00 03 41 10 53; 出力8dB設定" line146="        // FF+00+03+41=0x143 -&gt; 0x43" line147="        // Query FF 00 02 41 42" line148="        const response4 = Send_ZETag_command([0xff, 0x00, 0x03, 0x41,txPowerData, (0x43 + txPowerData) % 256])" line149="    }" line150="" line151="    /**" line152="     * set transmission frequency" line153="     */" line154="    //% blockId=Set_Frequency block=&quot;Set Frequency %frequency (Hz) %chNum (ch) %chStep&quot;" line155="    //% weight=80 blockGap=8" line156="    //% Frequency.min=470000000 Frequency.max=928000000 Frequency.defl=922080000" line157="    //% chNum.min=1 chNum.max=6 chNum.defl=2" line158="    //% chStep.min=1 chStep.max=2 chStep.defl=2" line159="    export function Set_Frequency(frequency: number, chNum: number, chStep: number): void {" line160="        // Query FF 00 02 40 41" line161="        if (chNum &lt;= 1) chNum = -1;" line162="        else if (chNum &gt;= 6) chNum = 6;" line163="" line164="        if (chStep == 0) chStep = 1;" line165="        else if (chStep &gt;= 2) chStep = 2;" line166="" line167="        if (frequency &lt; 470000000) frequency = 470000000;" line168="        else if (frequency &gt; 928000000) frequency = 928000000;" line169="        else if ((frequency &gt; 510000000) &amp;&amp; (frequency &lt; 920600000)) frequency = 510000000;" line170="" line171="        let txArray = [" line172="            0xff, 0x00, 0x08 + chNum, 0x40, 0x01," line173="            (frequency &gt;&gt; 24) &amp; 0xff," line174="            (frequency &gt;&gt; 16) &amp; 0xff," line175="            (frequency &gt;&gt; 8) &amp; 0xff," line176="            frequency &amp; 0xff," line177="            chNum, 0, 0, 0, 0, 0, 0, 0" line178="        ]" line179="        if (chNum &gt;= 2) {" line180="            for (let n = 0; n &lt; chNum; n++) {" line181="                txArray[10 + n] = n * chStep" line182="            }" line183="        } else {" line184="            txArray[4] = 0" line185="        }" line186="        let checkSum2 = 0" line187="        for (let o = 0; o &lt; chNum + 10; o++) {" line188="            checkSum2 += txArray[o]" line189="        }" line190="        checkSum2 %= 256" line191="        txArray[10 + chNum] = checkSum2" line192="" line193="        txArray = txArray.slice(0, 11 + chNum); //omit redandant data" line194="        " line195="        const response5 = Send_ZETag_command(txArray)" line196="    }" line197="}" numlines="198"></mutation></block></statement></block></xml>